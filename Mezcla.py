import pandas as pd
from sklearn.feature_selection import RFE
from sklearn.ensemble import ExtraTreesClassifier
from sklearn.metrics import ConfusionMatrixDisplay, confusion_matrix
from sklearn.model_selection import train_test_split
import matplotlib.pyplot as plt

# Cargar los datos del archivo CSV
data = pd.read_csv('APT-FIN/resultadosTotales.csv')

# Separar los atributos (X) y las etiquetas (y)
X = data.iloc[1:, 1:-1]  # Todas las columnas excepto la última y la primera
y = data.iloc[1:, -1]   # Última columna

# Crear el clasificador que se utilizará en RFE
clf = ExtraTreesClassifier()

# Crear el objeto RFE con el clasificador y el número de características a seleccionar
rfe = RFE(estimator=clf, n_features_to_select=5)

# Aplicar RFE al conjunto de datos
X_rfe = rfe.fit_transform(X, y)

# Obtener las características seleccionadas
selected_features = X.columns[rfe.support_]

# Dividir los datos en conjuntos de entrenamiento y prueba solo con las características seleccionadas
X_train, X_test, y_train, y_test = train_test_split(
    X_rfe, y, test_size=0.3, random_state=1121218
)

# Entrenar un clasificador ExtraTrees con las características seleccionadas
etc = ExtraTreesClassifier()
_ = etc.fit(X_train, y_train)

# Realizar predicciones en el conjunto de prueba
y_pred = etc.predict(X_test)

# Crear la matriz de confusión y visualizarla
fig, ax = plt.subplots(figsize=(8, 5))
cmp = ConfusionMatrixDisplay(
    confusion_matrix(y_test, y_pred),
    display_labels=y.unique().astype(str)
)

cmp.plot(ax=ax)
plt.show()

# Imprimir las características seleccionadas
print("Características seleccionadas:")
print(selected_features)
